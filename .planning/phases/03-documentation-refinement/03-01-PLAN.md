---
phase: 03-documentation-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - AGENTS.md
  - scripts/generate-report.js
  - scripts/lib/graphql-queries.js
  - .github/workflows/biweekly-reports.yml
autonomous: true

must_haves:
  truths:
    - "Maintainers can understand the biweekly reports system architecture from AGENTS.md"
    - "Maintainers can troubleshoot common failures using documented procedures"
    - "Script logs provide actionable information during failures"
    - "Error messages guide users to solutions"
  artifacts:
    - path: "AGENTS.md"
      provides: "Biweekly Reports System section with architecture, troubleshooting, and maintenance"
      contains: "## Biweekly Reports System"
      min_lines: 100
    - path: "scripts/generate-report.js"
      provides: "Enhanced error handling with retry logic and actionable messages"
      contains: "exponential backoff"
    - path: "scripts/lib/graphql-queries.js"
      provides: "Rate limit detection and retry logic"
      contains: "rate limit"
  key_links:
    - from: "AGENTS.md"
      to: "scripts/generate-report.js"
      via: "documentation references implementation"
      pattern: "generate-report\\.js"
    - from: "scripts/generate-report.js"
      to: "scripts/lib/graphql-queries.js"
      via: "error handling delegates to GraphQL module"
      pattern: "fetchProjectItems.*catch"
---

<objective>
Document biweekly reports system architecture in AGENTS.md and enhance error handling with retry logic, rate limit detection, and actionable error messages.

Purpose: Enable maintainers to understand, operate, and troubleshoot the reports system without diving into code. Ensure production-ready robustness with graceful failure handling.

Output: Comprehensive documentation in AGENTS.md and production-hardened error handling in automation scripts.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-documentation-refinement/03-CONTEXT.md

# Implementation references

@scripts/generate-report.js
@scripts/lib/graphql-queries.js
@scripts/lib/label-mapping.js
@scripts/lib/contributor-tracker.js
@scripts/lib/markdown-generator.js
@.github/workflows/biweekly-reports.yml

# Phase 1 & 2 summaries for implementation details

@.planning/phases/01-biweekly-reports/01-01-SUMMARY.md
@.planning/phases/01-biweekly-reports/01-02-SUMMARY.md
@.planning/phases/01-biweekly-reports/01-03-SUMMARY.md
@.planning/phases/02-navigation-discovery/02-02-SUMMARY.md

# Repository guidelines

@AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Biweekly Reports System section to AGENTS.md</name>
  <files>AGENTS.md</files>
  <action>
Add a new section "## Biweekly Reports System" after the "Changelog Package Tracking" section and before "## Repository Context" section.

Section structure:

### Architecture Overview

- System components (workflows, scripts, data flow)
- Multi-blog Docusaurus configuration
- GitHub Projects V2 API integration
- Data sources and processing pipeline

### How It Works

- Cron schedule (every Monday, biweekly filtering in script)
- ISO week number calculation (even weeks only)
- Project board data fetching (GraphQL with pagination)
- Label categorization and badge generation
- Contributor tracking with bot filtering
- Markdown generation and Git commit

### File Locations and Purposes

Table format listing:

- .github/workflows/biweekly-reports.yml - Automation workflow
- scripts/generate-report.js - Main orchestration script
- scripts/lib/graphql-queries.js - GraphQL client and queries
- scripts/lib/label-mapping.js - Static label color mappings
- scripts/lib/contributor-tracker.js - Historical contributor tracking
- scripts/lib/markdown-generator.js - Report markdown formatting
- reports/ - Generated report blog posts
- static/data/contributors-history.json - Auto-generated (gitignored)

### Manual Report Generation

Step-by-step instructions:

1. Export GITHUB_TOKEN: `export GITHUB_TOKEN=your_token`
2. Run generation script: `npm run generate-report`
3. Review generated report in `reports/YYYY-MM-DD-report.mdx`
4. Preview with: `npm run start`

### Testing Workflow Manually

Instructions for workflow_dispatch trigger:

1. Navigate to Actions tab in GitHub
2. Select "Generate Biweekly Report" workflow
3. Click "Run workflow" button
4. Select branch (main or test branch)
5. Monitor workflow execution logs

### Troubleshooting Guide

#### Issue: Script exits with "Skipping report generation (odd week)"

- **Cause:** Reports only run on even ISO week numbers
- **Solution:** This is expected behavior. Wait for next even week or override check for testing.

#### Issue: "GITHUB_TOKEN or GH_TOKEN environment variable required"

- **Cause:** Missing authentication token
- **Solution:** Export GITHUB_TOKEN with repo read access. In CI, this is automatic.

#### Issue: "GraphQL rate limit exceeded"

- **Cause:** Hit GitHub API rate limits (5,000 requests/hour authenticated)
- **Solution:** Wait for rate limit reset (check X-RateLimit-Reset header). Token increases limits.

#### Issue: "Network timeout" or "ECONNRESET"

- **Cause:** Network issues or GitHub API downtime
- **Solution:** Script now retries with exponential backoff (3 attempts). Check GitHub status.

#### Issue: Empty report sections

- **Cause:** No items completed in report window (quiet period)
- **Solution:** Expected behavior. Report still published with summary section.

#### Issue: "Failed to update contributor history"

- **Cause:** contributors-history.json is corrupted or unreadable
- **Solution:** Delete file and it will be regenerated (history reset).

### Updating Label Mappings

Process for refreshing label colors from projectbluefin/common:

1. Navigate to https://github.com/projectbluefin/common/labels
2. Note changes to label names or colors
3. Edit `scripts/lib/label-mapping.js`
4. Update LABEL_COLORS object with new hex values
5. Update LABEL_CATEGORIES if category structure changes
6. Test with: `npm run generate-report`

### Modifying Report Templates

How to customize report format:

1. Edit `scripts/lib/markdown-generator.js`
2. Functions to modify:
   - `generateFrontmatter()` - Report metadata
   - `generateSummary()` - Top summary section
   - `generateCategorySection()` - Work categorization
   - `generateBotSection()` - Bot activity tables
   - `generateContributorsSection()` - Contributors list
3. Test changes with: `npm run generate-report`
4. Validate with: `npm run build`

### Performance Considerations

- **Build time impact:** Report generation adds ~5-15 seconds to build
- **GraphQL API usage:** ~50 points per report (5,000 limit/hour)
- **Optimization:** GraphQL queries use cursor pagination for efficiency
- **Caching:** Not implemented (fresh data each run preferred)

### Auto-Generated Files - DO NOT COMMIT

Add to existing section:

- `static/data/contributors-history.json` - Generated by contributor tracking
  </action>
  <verify>

```bash
# Check section exists and has required content
grep -A 5 "## Biweekly Reports System" AGENTS.md
# Verify minimum content length (should be 100+ lines)
awk '/## Biweekly Reports System/,/## Repository Context/' AGENTS.md | wc -l
# Check key subsections exist
grep -E "(Architecture Overview|How It Works|Troubleshooting Guide)" AGENTS.md
```

  </verify>
  <done>
AGENTS.md contains complete "Biweekly Reports System" section (100+ lines) with architecture overview, file locations, manual generation instructions, workflow testing steps, troubleshooting guide with 6+ scenarios, label update process, template modification guide, and performance notes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance GraphQL error handling with rate limit detection and retry logic</name>
  <files>scripts/lib/graphql-queries.js</files>
  <action>
Add robust error handling to `fetchProjectItems` function:

1. **Rate limit detection:**
   - Catch GraphQL errors with "rate limit" in message
   - Parse X-RateLimit-Reset header from error response
   - Calculate time until reset
   - Log actionable message: "Rate limit exceeded. Resets in X minutes at [timestamp]"
   - Exit gracefully with code 1

2. **Network retry logic:**
   - Wrap GraphQL request in try-catch
   - On network errors (ECONNRESET, ETIMEDOUT, etc.): retry with exponential backoff
   - Max retries: 3 attempts
   - Backoff delays: 2s, 4s, 8s
   - Log each retry attempt: "Retry X/3 after network error: [error message]"
   - If all retries fail: exit with actionable error message

3. **Improved error messages:**
   - Authentication errors: "Authentication failed. Ensure GITHUB_TOKEN is valid and has repo read access."
   - GraphQL errors: Include query name and variables in error output
   - Generic errors: "Unexpected error during project board fetch: [message]"

4. **Error logging pattern:**

```javascript
// Example structure (adjust to fit existing code)
async function fetchProjectItemsWithRetry(org, projectNumber, attempt = 1) {
  try {
    // Existing graphql() call
    return await graphql(query, variables);
  } catch (error) {
    // Rate limit detection
    if (error.message?.includes("rate limit")) {
      const resetTime = error.headers?.["x-ratelimit-reset"];
      // Log and exit
    }

    // Network errors - retry
    if (
      ["ECONNRESET", "ETIMEDOUT", "ENOTFOUND"].includes(error.code) &&
      attempt < 3
    ) {
      const delay = Math.pow(2, attempt) * 1000;
      console.log(`Retry ${attempt}/3 after ${delay}ms...`);
      await new Promise((r) => setTimeout(r, delay));
      return fetchProjectItemsWithRetry(org, projectNumber, attempt + 1);
    }

    // All other errors
    throw error;
  }
}
```

Do NOT break existing functionality - enhance error handling only.
</action>
<verify>

```bash
# Check for rate limit handling
grep -i "rate limit" scripts/lib/graphql-queries.js
# Check for retry logic
grep -E "(retry|attempt|exponential)" scripts/lib/graphql-queries.js
# Verify error messages are actionable
grep -E "(Authentication failed|Ensure GITHUB_TOKEN)" scripts/lib/graphql-queries.js
# Test that script still works
GITHUB_TOKEN=$GITHUB_TOKEN npm run generate-report --dry-run 2>&1 | head -20
```

  </verify>
  <done>
scripts/lib/graphql-queries.js includes rate limit detection with reset time logging, network retry logic with exponential backoff (max 3 attempts), and improved error messages that guide users to solutions. Existing functionality preserved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add error handling and improved logging to main generation script</name>
  <files>scripts/generate-report.js, .github/workflows/biweekly-reports.yml</files>
  <action>
Enhance `scripts/generate-report.js`:

1. **Structured logging:**
   - Add timestamp to console.log statements: `[YYYY-MM-DD HH:MM:SS]`
   - Add log levels: INFO, WARN, ERROR
   - Example: `console.log('[2026-01-27 10:00:00] INFO: Fetching project board data...')`

2. **Empty data handling:**
   - If `itemsInWindow.length === 0`: log warning
   - Still generate report with summary: "This was a quiet period with no completed items."
   - Do NOT skip report generation

3. **Contributor history corruption handling:**
   - Wrap `updateContributorHistory()` in try-catch
   - If JSON.parse fails: log warning, reset history, continue
   - Message: "WARN: Contributor history corrupted. Resetting history file."

4. **GitHub Actions annotations:**
   - On success: log total items, contributors, new contributors
   - On failure: Use GitHub Actions syntax for errors
   - Example: `console.error('::error file=scripts/generate-report.js::Failed to generate report: [message]')`

5. **Exit codes:**
   - Success: exit 0
   - Skipped (odd week): exit 0 (not an error)
   - Rate limit: exit 1 with error annotation
   - Network failure (after retries): exit 1 with error annotation
   - Unexpected error: exit 1 with error annotation

Update `.github/workflows/biweekly-reports.yml`:

1. **Add continue-on-error handling:**
   - If generate-report fails: don't fail entire workflow
   - Log failure but continue to commit step (might have partial report)

2. **Add workflow annotations:**

```yaml
- name: Generate biweekly report
  id: generate
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: npm run generate-report
  continue-on-error: true

- name: Check generation result
  if: steps.generate.outcome == 'failure'
  run: |
    echo "::warning::Report generation encountered errors but will attempt commit"
```

Do NOT break existing workflow - enhance error handling only.
</action>
<verify>

```bash
# Check for structured logging
grep -E "\[.*\] (INFO|WARN|ERROR)" scripts/generate-report.js
# Check for empty data handling
grep -i "quiet period" scripts/generate-report.js
# Check for GitHub Actions annotations
grep "::error" scripts/generate-report.js
# Verify workflow has continue-on-error
grep "continue-on-error" .github/workflows/biweekly-reports.yml
# Test error handling
GITHUB_TOKEN=$GITHUB_TOKEN npm run generate-report 2>&1 | grep -E "\[.*\]"
```

  </verify>
  <done>
scripts/generate-report.js includes structured logging with timestamps and levels, empty data handling with "quiet period" messaging, contributor history corruption recovery, GitHub Actions error annotations, and proper exit codes. Workflow has continue-on-error handling. Existing functionality preserved.
  </done>
</task>

</tasks>

<verification>
**Overall validation:**

```bash
# TypeScript compilation passes
npm run typecheck

# Build succeeds
npm run build

# Format check passes
npm run prettier-lint

# Documentation section exists and is comprehensive
grep -A 100 "## Biweekly Reports System" AGENTS.md | wc -l  # Should be 100+

# Error handling code exists
grep -i "rate limit" scripts/lib/graphql-queries.js
grep -i "retry" scripts/lib/graphql-queries.js
grep "::error" scripts/generate-report.js

# Manual test report generation (if GITHUB_TOKEN available)
npm run generate-report 2>&1 | tee /tmp/report-generation.log
grep -E "\[.*\] (INFO|WARN|ERROR)" /tmp/report-generation.log
```

</verification>

<success_criteria>
**Documentation completeness:**

- AGENTS.md has "Biweekly Reports System" section with 100+ lines
- Section covers architecture, manual generation, testing, troubleshooting (6+ scenarios), label updates, template modifications, and performance
- All key files documented with purposes

**Error handling robustness:**

- Rate limit detection logs reset time and exits gracefully
- Network failures retry with exponential backoff (max 3 attempts)
- Empty data periods generate "quiet period" reports
- Contributor history corruption resets automatically
- All error messages are actionable and guide to solutions

**Logging improvements:**

- Structured logging with timestamps and levels
- GitHub Actions annotations for errors
- Progress indicators during operations
- Clear success/failure messages

**Quality gates:**

- TypeScript compilation passes
- Build completes successfully
- No new prettier-lint warnings
- Existing functionality preserved
  </success_criteria>

<output>
After completion, create `.planning/phases/03-documentation-refinement/03-01-SUMMARY.md`
</output>
