---
phase: 01-biweekly-reports
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/generate-report.js
  - scripts/lib/markdown-generator.js
  - reports/.gitkeep
autonomous: true

must_haves:
  truths:
    - "Script can calculate biweekly time windows (2-week periods ending Sunday)"
    - "Script can filter project items by date range"
    - "Script can categorize items by labels into sections"
    - "Script can separate bot activity from human contributions"
    - "Script generates markdown matching reference format exactly"
  artifacts:
    - path: "scripts/generate-report.js"
      provides: "Main report generation orchestration"
      min_lines: 150
    - path: "scripts/lib/markdown-generator.js"
      provides: "Report markdown formatting logic"
      exports: ["generateReportMarkdown", "generateCategorySection"]
      min_lines: 100
    - path: "reports/.gitkeep"
      provides: "Directory for generated report blog posts"
  key_links:
    - from: "scripts/generate-report.js"
      to: "scripts/lib/graphql-queries.js"
      via: "import fetchProjectItems"
      pattern: "import.*fetchProjectItems"
    - from: "scripts/generate-report.js"
      to: "scripts/lib/contributor-tracker.js"
      via: "import updateContributorHistory"
      pattern: "import.*updateContributorHistory"
    - from: "scripts/lib/markdown-generator.js"
      to: "scripts/lib/label-mapping.js"
      via: "import generateBadge"
      pattern: "import.*generateBadge"
---

<objective>
Build the report generation engine that transforms project board data into formatted markdown blog posts.

Purpose: Create the core logic for biweekly window calculation, data categorization, and markdown generation matching the reference format.
Output: Main generation script and markdown formatter that produces reports identical to https://github.com/projectbluefin/common/issues/166
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-biweekly-reports/01-CONTEXT.md
@.planning/phases/01-biweekly-reports/01-RESEARCH.md
@.planning/phases/01-biweekly-reports/01-01-SUMMARY.md
@scripts/lib/graphql-queries.js
@scripts/lib/label-mapping.js
@scripts/lib/contributor-tracker.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create markdown generator module</name>
  <files>scripts/lib/markdown-generator.js</files>
  <action>
Create `scripts/lib/markdown-generator.js` following RESEARCH.md Pattern for markdown generation (lines 603-652):

1. **generateReportMarkdown function**:
   - Accept parameters: (completedItems, contributors, newContributors, botActivity, startDate, endDate)
   - Generate frontmatter (title, date, tags) matching RESEARCH.md lines 780-796
   - Generate summary section (total items, contributor count, new contributors)
   - Generate categorized sections using LABEL_CATEGORIES from label-mapping
   - Generate bot activity section (aggregate table + collapsible details)
   - Generate contributors section (thank you list + new contributor highlights)
   - Generate footer (generation date, board link, issue link)

2. **generateCategorySection function**:
   - Accept (items, categoryName, categoryLabels) parameters
   - Filter items matching any label in categoryLabels
   - Group by label within category
   - Generate markdown list with badge + title + link format:
     ```markdown
     [![label](badge-url)](label-url) [#123 Issue Title](issue-url) by @username
     ```
   - Return empty string if no items in category (graceful degradation)

3. **generateBotActivityTable function**:
   - Accept botActivity array grouped by (repo, bot, count)
   - Generate markdown table:
     ```markdown
     | Repository            | Bot           | PRs |
     | --------------------- | ------------- | --- |
     | projectbluefin/common | renovate[bot] | 5   |
     ```

4. **generateBotDetailsList function**:
   - Accept bot items array
   - Generate collapsible `<details>` with full bot PR list
   - Format: "- [#123 PR Title](url) in repo"

**Reference format:** https://github.com/projectbluefin/common/issues/166 (see CONTEXT.md lines 105-110)

**Critical:** Match reference format EXACTLY - sections, emoji, badge style, table format, collapsible details

**Frontmatter schema** (RESEARCH.md lines 780-796):

```yaml
---
title: "Biweekly Report: YYYY-MM-DD to YYYY-MM-DD"
date: YYYY-MM-DD
tags: [biweekly-report, project-activity]
---
```

  </action>
  <verify>
```bash
npm run typecheck
node -e "const mg = require('./scripts/lib/markdown-generator.js'); console.log(typeof mg.generateReportMarkdown)"
grep "generateCategorySection" scripts/lib/markdown-generator.js
```
  </verify>
  <done>Module exports all generator functions, passes TypeScript checks, imports label-mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create main report generation script</name>
  <files>scripts/generate-report.js</files>
  <action>
Create `scripts/generate-report.js` as main orchestration script:

1. **Import dependencies:**

   ```javascript
   import { fetchProjectItems, filterByStatus } from "./lib/graphql-queries.js";
   import {
     updateContributorHistory,
     isBot,
   } from "./lib/contributor-tracker.js";
   import { generateReportMarkdown } from "./lib/markdown-generator.js";
   import { getCategoryForLabel } from "./lib/label-mapping.js";
   import {
     subWeeks,
     startOfDay,
     endOfDay,
     format,
     getISOWeek,
   } from "date-fns";
   import fs from "fs/promises";
   ```

2. **Biweekly schedule check** (RESEARCH.md Pitfall 6, lines 496-506):

   ```javascript
   const currentWeek = getISOWeek(new Date());
   if (currentWeek % 2 !== 0) {
     console.log("Skipping report (odd week - reports run on even weeks)");
     process.exit(0);
   }
   ```

3. **Calculate report window** (RESEARCH.md Pattern 4, lines 273-294):

   ```javascript
   function calculateReportWindow() {
     const reportDate = new Date(); // Today (Monday when workflow runs)
     const endDate = endOfDay(subWeeks(reportDate, 0)); // Sunday night
     const startDate = startOfDay(subWeeks(reportDate, 2)); // 2 weeks ago
     return { startDate, endDate };
   }
   ```

4. **Fetch and filter project data:**
   - Call `fetchProjectItems('projectbluefin', 2)` for project #2
   - Filter by Status="Done" column
   - Filter by date range (items updated within window)
   - Secondary: Include large "In Progress" items (size:M+ PRs) per CONTEXT.md lines 32-33

5. **Separate bots from humans:**

   ```javascript
   const humanItems = items.filter((item) => !isBot(item.content.author.login));
   const botItems = items.filter((item) => isBot(item.content.author.login));
   ```

6. **Track contributors:**

   ```javascript
   const contributors = [
     ...new Set(humanItems.map((i) => i.content.author.login)),
   ];
   const newContributors = await updateContributorHistory(contributors);
   ```

7. **Aggregate bot activity:**
   - Group botItems by (repository, bot username)
   - Count PRs per bot per repo
   - Format for table generation

8. **Generate and write markdown:**

   ```javascript
   const markdown = generateReportMarkdown(
     humanItems,
     contributors,
     newContributors,
     botActivity,
     startDate,
     endDate,
   );
   const filename = `reports/${format(endDate, "yyyy-MM-dd")}-report.md`;
   await fs.writeFile(filename, markdown, "utf8");
   console.log(`Report generated: ${filename}`);
   ```

9. **Error handling:**
   - Try/catch around GraphQL calls (handle rate limits, network errors)
   - Graceful exit if GITHUB_TOKEN missing
   - Log errors with actionable messages

**Environment requirements:**

- `GITHUB_TOKEN` env var (required for GitHub API auth)

**Critical:** Follow RESEARCH.md patterns exactly - biweekly check, date window calculation, bot filtering, contributor tracking
</action>
<verify>

```bash
npm run typecheck
node -e "console.log(require('fs').existsSync('./scripts/generate-report.js'))"
grep "calculateReportWindow" scripts/generate-report.js
grep "isBot" scripts/generate-report.js
```

  </verify>
  <done>Script exists, uses all infrastructure modules, calculates biweekly windows, passes TypeScript</done>
</task>

<task type="auto">
  <name>Task 3: Create reports directory</name>
  <files>reports/.gitkeep</files>
  <action>
Create `reports/` directory for generated blog post markdown files:

```bash
mkdir -p reports
touch reports/.gitkeep
```

**Purpose:** This directory will be configured as a separate Docusaurus blog instance in Plan 03. The .gitkeep ensures the directory is tracked by git even when empty.

**Content:** Generated markdown files will be named `YYYY-MM-DD-report.md` following Docusaurus blog post convention (RESEARCH.md lines 767-775).

**Note:** Actual blog configuration happens in Plan 03 (docusaurus.config.ts changes).
</action>
<verify>

```bash
test -d reports && echo "Reports directory exists"
test -f reports/.gitkeep && echo ".gitkeep file exists"
```

  </verify>
  <done>reports/ directory exists with .gitkeep file</done>
</task>

</tasks>

<verification>
After completing all tasks, verify the report generation engine:

1. **Markdown generator exists:**

   ```bash
   node -e "require('./scripts/lib/markdown-generator.js')"
   ```

2. **Main script exists and imports correctly:**

   ```bash
   node -e "require('./scripts/generate-report.js')"
   ```

3. **TypeScript compilation clean:**

   ```bash
   npm run typecheck
   ```

4. **Reports directory ready:**

   ```bash
   ls -la reports/
   ```

5. **Manual dry-run test** (optional, requires GITHUB_TOKEN):
   ```bash
   export GITHUB_TOKEN="your-token"
   node scripts/generate-report.js
   # Should either skip (odd week) or generate a report
   ```
   </verification>

<success_criteria>

- ✅ scripts/lib/markdown-generator.js exports generateReportMarkdown, generateCategorySection
- ✅ scripts/generate-report.js orchestrates full report generation flow
- ✅ Biweekly schedule check implemented (even/odd week filtering)
- ✅ Date window calculation uses date-fns
- ✅ Bot filtering separates human/bot contributions
- ✅ Contributor tracking integrates with infrastructure from Plan 01
- ✅ reports/ directory created with .gitkeep
- ✅ npm run typecheck passes with 0 errors
- ✅ All imports resolve correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/01-biweekly-reports/01-02-SUMMARY.md`
</output>
