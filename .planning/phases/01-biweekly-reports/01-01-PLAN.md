---
phase: 01-biweekly-reports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - scripts/lib/graphql-queries.js
  - scripts/lib/contributor-tracker.js
  - scripts/lib/label-mapping.js
  - static/data/contributors-history.json
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "GraphQL client can authenticate with GitHub API"
    - "Script can fetch project board items from Projects V2 API"
    - "Script can filter items by column status (Done, In Progress)"
    - "Script can identify bot vs human contributors"
    - "Script tracks new contributors across report runs"
  artifacts:
    - path: "scripts/lib/graphql-queries.js"
      provides: "GraphQL query definitions for Projects V2"
      exports: ["fetchProjectItems", "PROJECT_QUERY"]
      min_lines: 100
    - path: "scripts/lib/contributor-tracker.js"
      provides: "Historical contributor tracking"
      exports: ["updateContributorHistory", "getNewContributors"]
      min_lines: 50
    - path: "scripts/lib/label-mapping.js"
      provides: "Static label color mapping"
      exports: ["LABEL_COLORS", "LABEL_CATEGORIES"]
      min_lines: 30
    - path: "static/data/contributors-history.json"
      provides: "Historical contributor data (gitignored)"
      contains: '"contributors"'
  key_links:
    - from: "scripts/lib/graphql-queries.js"
      to: "@octokit/graphql"
      via: "import statement"
      pattern: "import.*@octokit/graphql"
    - from: "scripts/lib/contributor-tracker.js"
      to: "static/data/contributors-history.json"
      via: "fs.readFile/writeFile"
      pattern: 'contributors-history\.json'
---

<objective>
Build the data fetching infrastructure for biweekly reports using GitHub Projects V2 GraphQL API.

Purpose: Establish foundation for querying project board data, tracking contributors, and categorizing work by labels.
Output: Reusable modules for GraphQL queries, contributor tracking, and label mapping.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-biweekly-reports/01-CONTEXT.md
@.planning/phases/01-biweekly-reports/01-RESEARCH.md
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install GraphQL dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install required dependencies for GitHub GraphQL API and date manipulation:

```bash
npm install @octokit/graphql date-fns
```

**Why these libraries:**

- `@octokit/graphql@7.x`: Official GitHub GraphQL client with automatic pagination, auth, and rate limiting
- `date-fns@3.x`: Date manipulation for biweekly window calculations, ISO week handling

Do NOT use:

- `@octokit/rest`: Does not support Projects V2 API (GraphQL required)
- `moment.js`: Deprecated, use date-fns instead
- Plain `fetch` + GraphQL: Loses automatic pagination and rate limit handling
  </action>
  <verify>

```bash
npm list @octokit/graphql date-fns
grep -E '"@octokit/graphql"|"date-fns"' package.json
```

  </verify>
  <done>Both packages appear in package.json dependencies and are installed in node_modules</done>
</task>

<task type="auto">
  <name>Task 2: Create GraphQL query module</name>
  <files>scripts/lib/graphql-queries.js</files>
  <action>
Create `scripts/lib/graphql-queries.js` with:

1. **GraphQL query definition** matching research Pattern 1 (see 01-RESEARCH.md lines 86-168):
   - Query organization project by number (Projects V2 API)
   - Fetch items with pagination support (first: 100, after: $cursor)
   - Include fieldValues (Status column detection)
   - Include content (Issue/PullRequest discriminated unions)
   - Include labels (name, color, url) from linked issues/PRs
   - Include author information (login, name)

2. **Authenticated GraphQL client setup**:
   - Import @octokit/graphql
   - Configure with GITHUB_TOKEN from env
   - Export graphqlWithAuth singleton

3. **fetchProjectItems function**:
   - Accept (orgLogin, projectNumber) parameters
   - Execute query with pagination
   - Return array of project items
   - Handle errors gracefully (rate limits, network failures)

4. **Column filtering helpers**:
   - `filterByStatus(items, statusName)`: Filter items by column (e.g., "Done")
   - `getStatusValue(item)`: Extract Status field value from fieldValues

**Reference:** RESEARCH.md Pattern 1 (lines 86-168), Code Examples (lines 515-599)

**Critical:** Use pagination via @octokit/graphql iterator pattern to handle >100 items (see RESEARCH.md Pitfall 1)
</action>
<verify>

```bash
npm run typecheck
node -e "const q = require('./scripts/lib/graphql-queries.js'); console.log(typeof q.fetchProjectItems)"
grep -E "import.*@octokit/graphql" scripts/lib/graphql-queries.js
```

  </verify>
  <done>Module exports fetchProjectItems, uses @octokit/graphql, passes TypeScript compilation</done>
</task>

<task type="auto">
  <name>Task 3: Create label mapping module</name>
  <files>scripts/lib/label-mapping.js</files>
  <action>
Create `scripts/lib/label-mapping.js` with static label color mapping:

1. **LABEL_COLORS object** (from projectbluefin/common labels):
   - Map label names to GitHub hex colors (no # prefix)
   - Include all area/\* labels (gnome, aurora, dx, brew, iso, etc.)
   - Include all kind/\* labels (bug, enhancement, documentation, tech-debt)
   - Format: `{ "area/gnome": "0E8A16", "kind/bug": "D93F0B", ... }`

2. **LABEL_CATEGORIES object** matching CONTEXT.md (lines 43-53):

   ```javascript
   {
     "üñ•Ô∏è Desktop": ["area/gnome", "area/aurora", "area/bling"],
     "üõ†Ô∏è Development": ["area/dx", "area/buildstream", "area/finpilot"],
     "üì¶ Ecosystem": ["area/brew", "area/just", "area/bluespeed"],
     "‚öôÔ∏è System Services & Policies": ["area/services", "area/policy"],
     "üèóÔ∏è Infrastructure": ["area/iso", "area/upstream"],
     "üîß Bug Fixes": ["kind/bug"],
     "üöÄ Enhancements": ["kind/enhancement"],
     "üìö Documentation": ["kind/documentation"],
     "üßπ Tech Debt": ["kind/tech-debt"]
   }
   ```

3. **Helper functions**:
   - `getCategoryForLabel(labelName)`: Return category emoji + name for label
   - `generateBadge(label)`: Generate Shields.io badge markdown using Pattern 3 (RESEARCH.md lines 229-253)

**Badge format:** `[![label-name](https://img.shields.io/badge/{encoded-name}-{color}?style=flat-square)](label-url)`

**Critical:** Use hex colors WITHOUT # prefix (see RESEARCH.md Pitfall 4). Handle uncategorized labels gracefully (return "üìã Other").

**Label color reference:** Manually extract top 20 labels from https://github.com/projectbluefin/common/labels (or use reasonable defaults, colors can be refined later)
</action>
<verify>

```bash
npm run typecheck
node -e "const lm = require('./scripts/lib/label-mapping.js'); console.log(Object.keys(lm.LABEL_COLORS).length + ' labels mapped')"
grep "üñ•Ô∏è Desktop" scripts/lib/label-mapping.js
```

  </verify>
  <done>Module exports LABEL_COLORS, LABEL_CATEGORIES, generateBadge function, passes TypeScript checks</done>
</task>

<task type="auto">
  <name>Task 4: Create contributor tracking module</name>
  <files>scripts/lib/contributor-tracker.js, static/data/contributors-history.json, .gitignore</files>
  <action>
Create `scripts/lib/contributor-tracker.js`:

1. **updateContributorHistory function** matching RESEARCH.md Pattern 5 (lines 311-346):
   - Read `static/data/contributors-history.json` (create if not exists)
   - Accept array of contributor usernames from current report
   - Filter out bot accounts (use regex patterns from RESEARCH.md Pitfall 3)
   - Identify new contributors (not in historical list)
   - Append new usernames to contributors array
   - Update lastUpdated timestamp (ISO 8601)
   - Write updated history back to file
   - Return array of new contributor usernames

2. **Bot detection** (RESEARCH.md Pitfall 3, lines 425-436):

   ```javascript
   const BOT_PATTERNS = [
     /^dependabot\[bot\]$/,
     /^renovate\[bot\]$/,
     /^github-actions\[bot\]$/,
     /^ubot-\d+$/,
     /bot$/i,
   ];
   function isBot(username) {
     return BOT_PATTERNS.some((pattern) => pattern.test(username));
   }
   ```

3. **Export helpers**:
   - `updateContributorHistory(contributors)`: Main function
   - `getNewContributors(contributors)`: Identify new contributors
   - `isBot(username)`: Bot detection

4. **Initialize contributors-history.json** with empty structure:

   ```json
   {
     "lastUpdated": "2026-01-26T10:00:00Z",
     "contributors": []
   }
   ```

5. **Update .gitignore** to exclude auto-generated file:
   ```
   # Add to existing auto-generated files section
   static/data/contributors-history.json
   ```

**Storage location:** `static/data/contributors-history.json` (gitignored, persists via checkout action in CI)

**Critical:** Filter bots BEFORE updating history to prevent bot contamination (see RESEARCH.md Pitfall 3)
</action>
<verify>

```bash
npm run typecheck
test -f static/data/contributors-history.json && echo "History file created"
grep "contributors-history.json" .gitignore
node -e "const ct = require('./scripts/lib/contributor-tracker.js'); console.log(typeof ct.updateContributorHistory)"
```

  </verify>
  <done>Module exports tracking functions, history file exists, gitignore updated, TypeScript passes</done>
</task>

</tasks>

<verification>
After completing all tasks, verify the infrastructure:

1. **Dependencies installed:**

   ```bash
   npm list @octokit/graphql date-fns
   ```

2. **Modules created and importable:**

   ```bash
   node -e "require('./scripts/lib/graphql-queries.js')"
   node -e "require('./scripts/lib/label-mapping.js')"
   node -e "require('./scripts/lib/contributor-tracker.js')"
   ```

3. **TypeScript compilation clean:**

   ```bash
   npm run typecheck
   ```

4. **Gitignore updated:**

   ```bash
   grep "contributors-history.json" .gitignore
   ```

5. **History file initialized:**
   ```bash
   cat static/data/contributors-history.json | jq .
   ```
   </verification>

<success_criteria>

- ‚úÖ @octokit/graphql and date-fns installed in package.json
- ‚úÖ scripts/lib/graphql-queries.js exports fetchProjectItems function
- ‚úÖ scripts/lib/label-mapping.js exports LABEL_COLORS, LABEL_CATEGORIES, generateBadge
- ‚úÖ scripts/lib/contributor-tracker.js exports updateContributorHistory, isBot
- ‚úÖ static/data/contributors-history.json initialized with empty contributor array
- ‚úÖ .gitignore excludes contributors-history.json
- ‚úÖ npm run typecheck passes with 0 errors
- ‚úÖ All modules can be imported without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-biweekly-reports/01-01-SUMMARY.md`
</output>
